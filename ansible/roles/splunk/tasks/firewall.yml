---
- name: Install iptables-persistent
  ansible.builtin.apt:
    name:
      - iptables
      - iptables-persistent
    state: present
  tags:
    - molecule-notest

- name: Flush existing iptables rules
  ansible.builtin.iptables:
    flush: true
  tags:
    - molecule-notest

- name: Allow established connections (INPUT)
  ansible.builtin.iptables:
    chain: INPUT
    ctstate: ESTABLISHED,RELATED
    jump: ACCEPT
  tags:
    - molecule-notest

- name: Allow loopback (INPUT)
  ansible.builtin.iptables:
    chain: INPUT
    in_interface: lo
    jump: ACCEPT
  tags:
    - molecule-notest

- name: Allow SSH from allowed networks
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    destination_port: "22"
    source: "{{ item }}"
    jump: ACCEPT
  loop: "{{ splunk_allowed_networks }}"
  tags:
    - molecule-notest

- name: Allow Splunk Web UI from allowed networks
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    destination_port: "{{ splunk_ports.web }}"
    source: "{{ item }}"
    jump: ACCEPT
  loop: "{{ splunk_allowed_networks }}"
  tags:
    - molecule-notest

- name: Allow Splunk Management from allowed networks
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    destination_port: "{{ splunk_ports.mgmt }}"
    source: "{{ item }}"
    jump: ACCEPT
  loop: "{{ splunk_allowed_networks }}"
  tags:
    - molecule-notest

- name: Allow Splunk Forwarding from allowed networks
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    destination_port: "{{ splunk_ports.forwarding }}"
    source: "{{ item }}"
    jump: ACCEPT
  loop: "{{ splunk_allowed_networks }}"
  tags:
    - molecule-notest

- name: Allow Splunk Replication from allowed networks
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    destination_port: "{{ splunk_ports.replication }}"
    source: "{{ item }}"
    jump: ACCEPT
  loop: "{{ splunk_allowed_networks }}"
  tags:
    - molecule-notest

- name: Allow Splunk Clustering from allowed networks
  ansible.builtin.iptables:
    chain: INPUT
    protocol: tcp
    destination_port: "{{ splunk_ports.clustering }}"
    source: "{{ item }}"
    jump: ACCEPT
  loop: "{{ splunk_allowed_networks }}"
  tags:
    - molecule-notest

- name: Set INPUT policy to DROP
  ansible.builtin.iptables:
    chain: INPUT
    policy: DROP
  tags:
    - molecule-notest

- name: Allow outbound to allowed networks
  ansible.builtin.iptables:
    chain: OUTPUT
    destination: "{{ item }}"
    jump: ACCEPT
  loop: "{{ splunk_allowed_networks }}"
  tags:
    - molecule-notest

- name: Allow outbound established connections
  ansible.builtin.iptables:
    chain: OUTPUT
    ctstate: ESTABLISHED,RELATED
    jump: ACCEPT
  tags:
    - molecule-notest

- name: Allow outbound loopback
  ansible.builtin.iptables:
    chain: OUTPUT
    out_interface: lo
    jump: ACCEPT
  tags:
    - molecule-notest

- name: Set OUTPUT policy to DROP (network isolation)
  ansible.builtin.iptables:
    chain: OUTPUT
    policy: DROP
  tags:
    - molecule-notest

- name: Save iptables rules
  ansible.builtin.shell:
    cmd: iptables-save > /etc/iptables/rules.v4
  changed_when: true
  tags:
    - molecule-notest
