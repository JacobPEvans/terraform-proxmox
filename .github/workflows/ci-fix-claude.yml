# CI Failure Auto-Fix
#
# Monitors Terraform CI and Markdown Lint for failures on PR branches.
# Claude analyzes failure logs and pushes fixes (max 2 attempts per PR).

name: CI Fix (Claude)

on:
  workflow_run:
    workflows: ["Terraform CI", "Markdown Lint"]
    types: [completed]

concurrency:
  group: ci-fix-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: true

permissions: {}

jobs:
  should-fix:
    name: Check if fix needed
    if: >-
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.head_branch != 'main'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      issues: read
    outputs:
      pr_number: ${{ steps.find-pr.outputs.pr_number }}
      should_run: ${{ steps.check-attempts.outputs.should_run }}
      attempt: ${{ steps.check-attempts.outputs.attempt }}
    steps:
      - name: Find associated PR
        id: find-pr
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const branch = context.payload.workflow_run.head_branch;
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });
            if (prs.length === 0) {
              core.info(`No open PR for branch ${branch}`);
              core.setOutput('pr_number', '');
              return;
            }
            core.setOutput('pr_number', prs[0].number.toString());

      - name: Check attempt count
        id: check-attempts
        if: steps.find-pr.outputs.pr_number != ''
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.find-pr.outputs.pr_number }}');
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              per_page: 100
            });
            const attempts = comments.filter(c =>
              c.body.includes('<!-- claude-ci-fix-attempt -->')
            ).length;
            core.info(`Found ${attempts} previous fix attempts`);
            if (attempts >= 2) {
              core.info('Max attempts reached, skipping');
              core.setOutput('should_run', 'false');
              core.setOutput('attempt', attempts.toString());
            } else {
              core.setOutput('should_run', 'true');
              core.setOutput('attempt', (attempts + 1).toString());
            }

  post-attempt-comment:
    name: Post attempt marker
    needs: should-fix
    if: needs.should-fix.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Post tracking comment
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const prNumber = parseInt('${{ needs.should-fix.outputs.pr_number }}');
            const attempt = '${{ needs.should-fix.outputs.attempt }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `<!-- claude-ci-fix-attempt -->\n### CI Auto-Fix Attempt ${attempt}/2\n\nClaude is analyzing the CI failure and attempting a fix...`
            });

  get-failure-details:
    name: Get failure logs
    needs: should-fix
    if: needs.should-fix.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      actions: read
    outputs:
      failure_logs: ${{ steps.get-logs.outputs.logs }}
    steps:
      - name: Download failure logs
        id: get-logs
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const runId = context.payload.workflow_run.id;
            const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });
            let logs = '';
            for (const job of jobs.jobs.filter(j => j.conclusion === 'failure')) {
              logs += `\n=== FAILED JOB: ${job.name} ===\n`;
              try {
                const logData = await github.rest.actions.downloadJobLogsForWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  job_id: job.id
                });
                const logLines = logData.data.split('\n');
                logs += logLines.slice(-200).join('\n');
              } catch (e) {
                logs += `(Could not download logs: ${e.message})\n`;
              }
            }
            const truncated = logs.length > 60000 ? logs.slice(-60000) : logs;
            core.setOutput('logs', truncated);

  fix:
    name: Claude Fix
    needs: [should-fix, get-failure-details, post-attempt-comment]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    timeout-minutes: 15
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0
          token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

      - name: Run Claude Code
        uses: anthropics/claude-code-action@2f8ba26a219c06cfb0f468eef8d97055fa814f97 # v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          direct_prompt: |
            ## CI Failure Auto-Fix

            You are fixing a CI failure in the terraform-proxmox repository. This is a
            Terraform/OpenTofu project managing Proxmox VE infrastructure.

            ### CI Structure
            - `terraform.yml` ("Terraform CI") - Runs tofu fmt -check, init, validate, and test
            - `markdown-lint.yml` ("Markdown Lint") - Lints markdown files with markdownlint

            ### Failure Logs
            ```
            ${{ needs.get-failure-details.outputs.failure_logs }}
            ```

            ### Instructions
            1. Analyze the failure logs to identify the root cause
            2. Fix the issue in the source files
            3. Commit the fix with message: "fix: resolve CI failure (auto-fix attempt ${{ needs.should-fix.outputs.attempt }})"
            4. Push to the PR branch

            Only fix what the CI is complaining about. Do not refactor or improve unrelated code.
            If the failure is in terraform, validate your fix with `tofu validate` before committing.

          allowed_tools: "Edit,MultiEdit,Write,Read,Glob,Grep,LS,Bash(git:*),Bash(tofu:*)"
