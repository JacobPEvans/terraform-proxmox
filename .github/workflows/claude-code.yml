name: Claude Code Setup Check

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

jobs:
  claude-setup-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Claude Code Integration Setup
        run: |
          echo "üîç Checking Claude Code GitHub integration setup..."
          echo ""
          echo "Required for Claude Code integration:"
          echo "1. üì± Claude GitHub App must be installed on this repository"
          echo "2. üîë ANTHROPIC_API_KEY must be added to repository secrets"
          echo "3. üìù Official Claude Code GitHub Action must be used"
          echo ""
          echo "Current status:"
          if [ -n "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "‚úÖ ANTHROPIC_API_KEY secret is configured"
          else
            echo "‚ùå ANTHROPIC_API_KEY secret is missing"
            echo "   Add it in: Settings > Secrets and variables > Actions"
          fi
          echo ""
          echo "To complete Claude Code setup:"
          echo "1. Install Claude GitHub App: https://github.com/apps/claude-code"
          echo "2. Add ANTHROPIC_API_KEY to repository secrets"
          echo "3. Use official Claude Code Action in workflow"
          echo ""
          echo "This workflow will be updated once proper setup is confirmed."

      - name: Comment on PR about Claude setup
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const hasApiKey = '${{ secrets.ANTHROPIC_API_KEY }}' !== '';
            const setupStatus = hasApiKey ? '‚úÖ' : '‚ùå';
            
            const comment = `## ü§ñ Claude Code Integration Status
            
            ${setupStatus} **Setup Status**: ${hasApiKey ? 'Partially configured' : 'Not configured'}
            
            ### Required Setup Steps:
            1. **Claude GitHub App**: Install at https://github.com/apps/claude-code
            2. **API Key**: ${hasApiKey ? '‚úÖ Configured' : '‚ùå Missing - add ANTHROPIC_API_KEY to repository secrets'}
            3. **Workflow**: ${hasApiKey ? 'Needs official action' : 'Pending API key'}
            
            Once setup is complete, Claude Code will automatically review PRs and respond to @claude mentions.
            
            ### Current PR Analysis (Manual):
            This PR enhances infrastructure security by:
            - ‚úÖ Removing hardcoded SSH key references
            - ‚úÖ Adding secure variable-based SSH key management
            - ‚úÖ Implementing cloud-init automation support
            - ‚úÖ Following Infrastructure as Code best practices
            
            **Security Impact**: üîí Improved - all SSH keys now configurable via variables
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });